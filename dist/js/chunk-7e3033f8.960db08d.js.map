{"version":3,"sources":["webpack:///./node_modules/@arcgis/core/layers/graphics/sources/connections/StreamConnection.js","webpack:///./node_modules/@arcgis/core/layers/graphics/sources/connections/WebSocketConnection.js","webpack:///./node_modules/@arcgis/core/layers/graphics/sources/connections/GeoEventConnection.js","webpack:///./node_modules/@arcgis/core/layers/graphics/sources/connections/createConnection.js","webpack:///./node_modules/@arcgis/core/layers/graphics/data/StreamFeatureManager.js","webpack:///./node_modules/@arcgis/core/core/CircularArray.js","webpack:///./node_modules/@arcgis/core/layers/graphics/controllers/StreamController.js","webpack:///./node_modules/@arcgis/core/views/layers/StreamLayerView.js","webpack:///./node_modules/@arcgis/core/views/3d/layers/StreamLayerView3D.js"],"names":["EventedMixin","r","this","emit","getLogger","e","CONNECTING","OPEN","CLOSING","CLOSED","super","errorString","geometryType","t","spatialReference","o","sourceSpatialReference","_config","_featureZScaler","_open","_tryCreateWebSocket","destroyed","_handshake","_websocket","onopen","onclose","onerror","onmessage","close","readyState","source","path","customParameters","_createWebSocket","notifyChange","s","c","maxReconnectionAttempts","error","destroy","Math","min","maxReconnectionInterval","Promise","WebSocket","_onClose","_onError","_onMessage","n","filter","i","outFields","a","l","timeout","JSON","parse","data","d","reject","wkid","format","resolve","send","stringify","promise","type","features","geometry","onFeature","_set","code","prototype","g","_","maxQueryDepth","maxRecordCountFactor","w","_fetchServiceDefinition","timeInfo","trackIdField","warn","_fetchWebSocketUrl","streamUrls","_buddyServicesQuery","_queryBuddyServices","_setFilter","_enrich","f","query","responseType","_serviceDefinition","urls","token","_inferWebSocketBaseUrl","outSR","length","indexOf","_serializeFilter","u","bind","setTimeout","shiftCentralMeridian","where","join","_relatedFeatures","relatedFeatures","joinField","attributes","has","get","centroid","keepLatestArchive","_queryRelatedFeatures","_queryArchive","_queryBuddy","featuresUrl","_addRelatedFeatures","url","capabilities","load","supportsMaxRecordCountFactor","supportsPagination","supportsCentroid","maxRecordCount","returnGeometry","returnExceededLimitFeatures","outSpatialReference","fromJSON","returnCentroid","num","_queryPages","y","start","exceededTransferLimit","forEach","push","Map","set","F","m","p","h","_trackIdToObservations","_idCounter","_lastPurge","performance","now","_addOrUpdated","_removed","_maxAge","_timeInfo","_purgeOptions","store","objectIdField","purgeInterval","_useGeneratedIds","_nextId","objectId","max","startTimeField","_trackIdLessObservations","enqueue","maxObservations","delete","_getToAdd","_getToRemove","_purge","removeById","add","update","size","Array","clear","_purgeSomeByDisplayCount","_purgeByAge","_purgeByAgeReceived","_purgeTracks","displayCount","values","dequeue","age","ageReceived","_start","maxSize","_buffer","cloneProperties","Number","json","read","onUpdate","_idToGraphic","sourceLayer","layer","arguments","_updateInfo","websocket","client","graphics","addResolvingPromise","when","_startup","_updateIntervalId","clearInterval","connection","handles","removeAll","connectionStatus","parsedUrl","definitionExpression","geometryDefinition","purgeOptions","updateInterval","toJSON","layerView","view","_outSpatialReference","_onUpdate","featuresManager","on","_onFeature","watch","I","setInterval","round","checkForUpdates","hasEventListener","removeMany","addMany","readOnly","connectionError","aliasOf","updatePolicy","hasZ","hasM","queryEngine","executeQueryForLatestObservations","_ensureQuery","signal"],"mappings":"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","file":"js/chunk-7e3033f8.960db08d.js","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.22/esri/copyright.txt for details.\n*/\nimport{_ as r}from\"../../../../chunks/tslib.es6.js\";import e from\"../../../../core/Evented.js\";import{HandleOwner as s}from\"../../../../core/HandleOwner.js\";import\"../../../../core/Logger.js\";import\"../../../../core/accessorSupport/ensureType.js\";import\"../../../../core/arrayUtils.js\";import\"../../../../core/has.js\";import\"../../../../core/accessorSupport/set.js\";import{subclass as o}from\"../../../../core/accessorSupport/decorators/subclass.js\";let t=class extends(e.EventedMixin(s)){onFeature(r){this.emit(\"feature\",r)}};t=r([o(\"esri.layers.graphics.sources.connections.StreamConnection\")],t);const c=t;export{c as default};\n","/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.22/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../../chunks/tslib.es6.js\";import t from\"../../../../core/Error.js\";import o from\"../../../../core/Logger.js\";import{isSome as r,isNone as s}from\"../../../../core/maybe.js\";import{after as n,createResolver as c}from\"../../../../core/promiseUtils.js\";import{addQueryParameters as i}from\"../../../../core/urlUtils.js\";import{property as a}from\"../../../../core/accessorSupport/decorators/property.js\";import\"../../../../core/arrayUtils.js\";import\"../../../../core/has.js\";import\"../../../../core/accessorSupport/ensureType.js\";import{subclass as l}from\"../../../../core/accessorSupport/decorators/subclass.js\";import{getGeometryZScaler as d}from\"../../../../geometry/support/zscale.js\";import h from\"./StreamConnection.js\";const p=o.getLogger(\"esri.layers.graphics.sources.connections.WebSocketConnection\");var u;!function(e){e[e.CONNECTING=0]=\"CONNECTING\",e[e.OPEN=1]=\"OPEN\",e[e.CLOSING=2]=\"CLOSING\",e[e.CLOSED=3]=\"CLOSED\"}(u||(u={}));let m=class extends h{constructor(e){super(),this.errorString=null;const{geometryType:t,spatialReference:o,sourceSpatialReference:r}=e;this._config=e,this._featureZScaler=d(t,r,o),this._open()}async _open(){await this._tryCreateWebSocket(),this.destroyed||await this._handshake()}destroy(){r(this._websocket)&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null}get connectionStatus(){if(s(this._websocket))return\"disconnected\";switch(this._websocket.readyState){case u.CONNECTING:case u.OPEN:return\"connected\";case u.CLOSING:case u.CLOSED:return\"disconnected\"}}async _tryCreateWebSocket(e=this._config.source.path,o=1e3,r=0){try{if(this.destroyed)return;const t=i(e,this._config.customParameters);this._websocket=await this._createWebSocket(t),this.notifyChange(\"connectionStatus\")}catch(s){const c=o/1e3;return this._config.maxReconnectionAttempts&&r>=this._config.maxReconnectionAttempts?(p.error(new t(\"websocket-connection\",\"Exceeded maxReconnectionAttempts attempts. No further attempts will be made\")),void this.destroy()):(p.error(new t(\"websocket-connection\",`Failed to connect. Attempting to reconnect in ${c}s`,s)),await n(o),this._tryCreateWebSocket(e,Math.min(1.5*o,1e3*this._config.maxReconnectionInterval),r+1))}}_createWebSocket(e){return new Promise(((t,o)=>{const r=new WebSocket(e);r.onopen=()=>{if(r.onopen=null,this.destroyed)return r.onclose=null,void r.close();r.onclose=e=>this._onClose(e),r.onerror=e=>this._onError(e),r.onmessage=e=>this._onMessage(e),t(r)},r.onclose=e=>{r.onopen=r.onclose=null,o(e)}}))}async _handshake(e=1e4){const o=this._websocket;if(s(o))return;const r=c(),n=o.onmessage,{filter:i,outFields:a,spatialReference:l}=this._config;return r.timeout(e),o.onmessage=e=>{var s;let c=null;try{c=JSON.parse(e.data)}catch(d){}c&&\"object\"==typeof c||(p.error(new t(\"websocket-connection\",\"Protocol violation. Handshake failed - malformed message\",e.data)),r.reject(),this.destroy()),(null==(s=c.spatialReference)?void 0:s.wkid)!==(null==l?void 0:l.wkid)&&(p.error(new t(\"websocket-connection\",`Protocol violation. Handshake failed - expected wkid of ${l.wkid}`,e.data)),r.reject(),this.destroy()),\"json\"!==c.format&&(p.error(new t(\"websocket-connection\",\"Protocol violation. Handshake failed - format is not set\",e.data)),r.reject(),this.destroy()),i&&c.filter!==i&&p.error(new t(\"websocket-connection\",\"Tried to set filter, but server doesn't support it\")),a&&c.outFields!==a&&p.error(new t(\"websocket-connection\",\"Tried to set outFields, but server doesn't support it\")),o.onmessage=n,r.resolve()},o.send(JSON.stringify({filter:i,outFields:a,format:\"json\",spatialReference:{wkid:l.wkid}})),r.promise}_onMessage(e){try{const o=JSON.parse(e.data);if(\"featureResult\"!==o.type)throw new t(\"websocket-connection\",\"Protocol violation - Expected to find message of type 'featureResult'\",o);for(const e of o.features)r(this._featureZScaler)&&this._featureZScaler(e.geometry),this.onFeature(e)}catch(o){return p.error(new t(\"websocket-connection\",\"Failed to parse message\",o)),void this.destroy()}}_onError(e){const t=\"Encountered an error over WebSocket connection\";this._set(\"errorString\",t),p.error(\"websocket-connection\",t)}_onClose(e){this._websocket=null,this.notifyChange(\"connectionStatus\"),1e3!==e.code&&p.error(\"websocket-connection\",`WebSocket closed unexpectedly with error code ${e.code}`),this.destroyed||this._open()}};e([a()],m.prototype,\"connectionStatus\",null),e([a()],m.prototype,\"errorString\",void 0),m=e([l(\"esri.layers.graphics.sources.connections.WebSocketConnection\")],m);export{u as ReadyState,m as WebSocketConnection};\n","/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.22/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../../chunks/tslib.es6.js\";import\"../../../../geometry.js\";import t from\"../../../../request.js\";import r from\"../../../../core/Error.js\";import o from\"../../../../core/Logger.js\";import{isSome as s,isNone as i,unwrapOr as n,get as a}from\"../../../../core/maybe.js\";import{createResolver as c}from\"../../../../core/promiseUtils.js\";import{addQueryParameters as u}from\"../../../../core/urlUtils.js\";import\"../../../../core/accessorSupport/ensureType.js\";import\"../../../../core/arrayUtils.js\";import\"../../../../core/has.js\";import\"../../../../core/accessorSupport/set.js\";import{subclass as f}from\"../../../../core/accessorSupport/decorators/subclass.js\";import{WebSocketConnection as d}from\"./WebSocketConnection.js\";import{executeQuery as h}from\"../../../../rest/query/operations/query.js\";import l from\"../../../../rest/support/Query.js\";import{fromJSON as y}from\"../../../../geometry/support/jsonUtils.js\";import m from\"../../../../geometry/SpatialReference.js\";const p=o.getLogger(\"esri.layers.graphics.sources.connections.GeoEventConnection\"),g=1e4,_={maxQueryDepth:5,maxRecordCountFactor:3};let w=class extends d{constructor(e){super({..._,...e})}async _open(){const e=await this._fetchServiceDefinition(this._config.source);e.timeInfo.trackIdField||p.warn(\"GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect.\");const t=this._fetchWebSocketUrl(e.streamUrls,this._config.spatialReference);this._buddyServicesQuery||(this._buddyServicesQuery=this._queryBuddyServices()),await this._buddyServicesQuery,await this._tryCreateWebSocket(t);const{filter:r,outFields:o}=this._config;this.destroyed||this._setFilter(r,o)}_onMessage(e){let t;try{t=this._enrich(JSON.parse(e.data)),s(this._featureZScaler)&&this._featureZScaler(t.geometry)}catch(o){return void p.error(new r(\"geoevent-connection\",\"Failed to parse message\",o))}this.onFeature(t)}async _fetchServiceDefinition(e){const r={f:\"json\",...this._config.customParameters},o=t(e.path,{query:r,responseType:\"json\"}),s=(await o).data;return this._serviceDefinition=s,s}_fetchWebSocketUrl(e,t){const r=e[0],{urls:o,token:s}=r,i=this._inferWebSocketBaseUrl(o);return u(`${i}/subscribe`,{outSR:\"\"+t.wkid,token:s})}_inferWebSocketBaseUrl(e){if(1===e.length)return e[0];for(const t of e)if(-1!==t.indexOf(\"wss\"))return t;return p.error(new r(\"geoevent-connection\",\"Unable to infer WebSocket url\",e)),null}async _setFilter(e,t){const o=this._websocket;if(i(o)||i(e)&&i(t))return;const s=JSON.stringify({filter:this._serializeFilter(e,t)});let n=!1;const a=c(),u=()=>{n||(this.destroyed||this._websocket!==o||p.error(new r(\"geoevent-connection\",\"Server timed out when setting filter\")),a.reject())},f=e=>{const t=JSON.parse(e.data);t.filter&&(t.error&&(p.error(new r(\"geoevent-connection\",\"Failed to set service filter\",t.error)),this._set(\"errorString\",`Could not set service filter - ${t.error}`),a.reject(t.error)),o.onmessage=this._onMessage.bind(this),n=!0,a.resolve())};return o.onmessage=f,o.send(s),setTimeout(u,g),a.promise}_serializeFilter(e,t){const o={};if(i(e)&&i(t))return o;if(s(e)&&e.geometry)try{const t=y(e.geometry);if(\"extent\"!==t.type)throw new r(`Expected extent but found type ${t.type}`);o.geometry=JSON.stringify(t.shiftCentralMeridian())}catch(n){p.error(new r(\"geoevent-connection\",\"Encountered an error when setting connection geometryDefinition\",n))}return s(e)&&e.where&&\"1 = 1\"!==e.where&&(o.where=e.where),s(t)&&(o.outFields=t.join(\",\")),o}_enrich(e){if(!this._relatedFeatures)return e;const t=this._serviceDefinition.relatedFeatures.joinField,o=e.attributes[t];if(!this._relatedFeatures.has(o))return p.warn(\"geoevent-connection\",\"Feature join failed. Is the join field configured correctly?\",e),e;const{attributes:s,geometry:i}=this._relatedFeatures.get(o);for(const r in s)e.attributes[r]=s[r];return i&&(e.geometry=i),e.geometry||e.centroid||p.error(new r(\"geoevent-connection\",\"Found malformed feature - no geometry found\",e)),e}async _queryBuddyServices(){try{const{relatedFeatures:e,keepLatestArchive:t}=this._serviceDefinition,r=this._queryRelatedFeatures(e),o=this._queryArchive(t);await r;const s=await o;if(!s)return;for(const i of s.features)this.onFeature(this._enrich(i))}catch(e){p.error(new r(\"geoevent-connection\",\"Encountered an error when querying buddy services\",{error:e}))}}async _queryRelatedFeatures(e){if(!e)return;const t=await this._queryBuddy(e.featuresUrl);this._addRelatedFeatures(t)}async _queryArchive(e){if(e)return this._queryBuddy(e.featuresUrl)}async _queryBuddy(e){const t=new((await import(\"../../../FeatureLayer.js\")).default)({url:e}),{capabilities:r}=await t.load(),o=r.query.supportsMaxRecordCountFactor,s=r.query.supportsPagination,i=r.query.supportsCentroid,c=this._config.maxRecordCountFactor,u=t.capabilities.query.maxRecordCount,f=o?u*c:u,d=new l;if(d.outFields=n(this._config.outFields,[\"*\"]),d.where=n(a(this._config.filter,\"where\"),\"1=1\"),d.returnGeometry=!0,d.returnExceededLimitFeatures=!0,d.outSpatialReference=m.fromJSON(this._config.spatialReference),i&&(d.returnCentroid=!0),o&&(d.maxRecordCountFactor=c),s)return d.num=f,t.destroy(),this._queryPages(e,d);const y=await h(e,d,this._config.sourceSpatialReference);return t.destroy(),y.data}async _queryPages(e,t,r=[],o=0){t.start=s(t.num)?o*t.num:null;const{data:i}=await h(e,t,this._config.sourceSpatialReference);return i.exceededTransferLimit&&o<this._config.maxQueryDepth?(i.features.forEach((e=>r.push(e))),this._queryPages(e,t,r,o+1)):(r.forEach((e=>i.features.push(e))),i)}_addRelatedFeatures(e){const t=new Map,r=e.features,o=this._serviceDefinition.relatedFeatures.joinField;for(const s of r){const e=s.attributes[o];t.set(e,s)}this._relatedFeatures=t}};w=e([f(\"esri.layers.graphics.sources.connections.GeoEventConnection\")],w);const F=w;export{F as default};\n","/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.22/esri/copyright.txt for details.\n*/\nimport e from\"./GeoEventConnection.js\";import{WebSocketConnection as n}from\"./WebSocketConnection.js\";function t(t,o,r,c,i,s,a,m){const p=0===t.path.indexOf(\"wss://\")||0===t.path.indexOf(\"ws://\"),f={source:t,sourceSpatialReference:o,spatialReference:r,geometryType:c,filter:i,maxReconnectionAttempts:s,maxReconnectionInterval:a,customParameters:m};return p?new n(f):new e(f)}export{t as createConnection};\n","/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.22/esri/copyright.txt for details.\n*/\nimport t from\"../../../core/CircularArray.js\";import{clamp as e}from\"../../../core/mathUtils.js\";import{isNone as s,isSome as i,unwrap as r}from\"../../../core/maybe.js\";const o=\"__esri_stream_id__\",d=\"__esri_timestamp__\",a=1e3;class h{constructor(t,e,s,i,r=128){this._trackIdToObservations=new Map,this._idCounter=0,this._lastPurge=performance.now(),this._addOrUpdated=new Map,this._removed=[],this._maxAge=0,this._timeInfo=s,this._purgeOptions=i,this.store=t,this.objectIdField=e,this.purgeInterval=r,this._useGeneratedIds=this.objectIdField===o}add(r){if(this._useGeneratedIds){const t=this._nextId();r.attributes[this.objectIdField]=t,r.objectId=t}else r.objectId=r.attributes[this.objectIdField];if(this._addOrUpdated.set(r.objectId,r),this._maxAge=Math.max(this._maxAge,r.attributes[this._timeInfo.startTimeField]),!this._timeInfo.trackIdField)return s(this._trackIdLessObservations)&&(this._trackIdLessObservations=new t(1e5)),void this._trackIdLessObservations.enqueue(r.objectId);const o=r.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(o)){const s=i(this._purgeOptions)&&null!=this._purgeOptions.maxObservations?this._purgeOptions.maxObservations:a,r=e(s,0,a);this._trackIdToObservations.set(o,new t(r))}const d=this._trackIdToObservations.get(o).enqueue(r.objectId);i(d)&&(this._addOrUpdated.has(d)?this._addOrUpdated.delete(d):this._removed.push(d))}checkForUpdates(){const t=this._getToAdd(),e=this._getToRemove(),s=performance.now();s-this._lastPurge>=this.purgeInterval&&(this._purge(s),this._lastPurge=s);const r=[];if(i(e))for(const o of e){const t=this.store.removeById(o);i(t)&&r.push(t)}if(i(t))for(const i of t)i.attributes[d]=s,this.store.add(i);(t||r)&&this.store.update(t,r)}_getToAdd(){if(!this._addOrUpdated.size)return null;const t=new Array(this._addOrUpdated.size);let e=0;return this._addOrUpdated.forEach((s=>t[e++]=s)),this._addOrUpdated.clear(),t}_getToRemove(){const t=this._removed;return this._removed.length?(this._removed=[],t):null}_nextId(){const t=this._idCounter;return this._idCounter=(this._idCounter+1)%4294967294+1,t}_purge(t){const e=this._purgeOptions;i(e)&&(this._purgeSomeByDisplayCount(e),this._purgeByAge(e),this._purgeByAgeReceived(t,e),this._purgeTracks())}_purgeSomeByDisplayCount(t){if(!t.displayCount)return;let e=this.store.size;if(e>t.displayCount){if(this._timeInfo.trackIdField)for(const s of this._trackIdToObservations.values())if(e>t.displayCount&&s.size){const t=r(s.dequeue());this._removed.push(t),e--}if(i(this._trackIdLessObservations)){let s=e-t.displayCount;for(;s-- >0;){const t=this._trackIdLessObservations.dequeue();i(t)&&this._removed.push(t)}}}}_purgeByAge(t){var e;if(!t.age||null==(e=this._timeInfo)||!e.startTimeField)return;const s=60*t.age*1e3,i=this._maxAge-s;this.store.forEach((t=>{t.attributes[this._timeInfo.startTimeField]<i&&this._removed.push(t.objectId)}))}_purgeByAgeReceived(t,e){if(!e.ageReceived)return;const s=t-60*e.ageReceived*1e3;this.store.forEach((t=>{t.attributes[d]<s&&this._removed.push(t.objectId)}))}_purgeTracks(){this._trackIdToObservations.forEach(((t,e)=>{0===t.size&&this._trackIdToObservations.delete(e)}))}}export{o as DEFAULT_STREAM_ID_FIELD,d as ESRI_TIMESTAMP,h as default};\n","/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.22/esri/copyright.txt for details.\n*/\nimport{isSome as t}from\"./maybe.js\";class s{constructor(t){this.size=0,this._start=0,this.maxSize=t,this._buffer=new Array(t)}get entries(){return this._buffer}enqueue(t){if(this.size===this.maxSize){const s=this._buffer[this._start];return this._buffer[this._start]=t,this._start=(this._start+1)%this.maxSize,s}return this._buffer[(this._start+this.size++)%this.maxSize]=t,null}dequeue(){if(0===this.size)return null;const t=this._buffer[this._start];return this._buffer[this._start]=null,this.size--,this._start=(this._start+1)%this.maxSize,t}peek(){return 0===this.size?null:this._buffer[this._start]}find(s){if(0===this.size)return null;for(const e of this._buffer)if(t(e)&&s(e))return e;return null}clear(s){let e=this.dequeue();for(;t(e);)s&&s(e),e=this.dequeue()}}export{s as default};\n","/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.22/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../chunks/tslib.es6.js\";import\"../../../geometry.js\";import t from\"../../../Graphic.js\";import r from\"../../../core/Accessor.js\";import{HandleOwnerMixin as o}from\"../../../core/HandleOwner.js\";import{isSome as s}from\"../../../core/maybe.js\";import{EsriPromiseMixin as i}from\"../../../core/Promise.js\";import{property as a}from\"../../../core/accessorSupport/decorators/property.js\";import\"../../../core/arrayUtils.js\";import\"../../../core/has.js\";import\"../../../core/accessorSupport/ensureType.js\";import{subclass as n}from\"../../../core/accessorSupport/decorators/subclass.js\";import c from\"../data/StreamFeatureManager.js\";import{createConnection as p}from\"../sources/connections/createConnection.js\";import{EventedSet as h}from\"../../../views/3d/support/EventedSet.js\";import{featureGeometryTypeKebabDictionary as d}from\"../../../geometry/support/typeUtils.js\";var l;const u=2500;let m=l=class extends t{getObjectId(){return this.objectId}clone(){return new l({objectId:this.objectId,...this.cloneProperties()})}};e([a({type:Number,json:{read:!0}})],m.prototype,\"objectId\",void 0),m=l=e([n(\"esri.layers.graphics.controllers.StreamGraphic\")],m);class y{constructor(e){this.onUpdate=e,this._idToGraphic=new Map}destroy(){this._idToGraphic.clear()}add(e){this._idToGraphic.set(e.objectId,e)}get(e){return this._idToGraphic.get(e)}forEach(e){this._idToGraphic.forEach(e)}removeById(e){const t=this._idToGraphic.get(e);return t?(t.sourceLayer=t.layer=null,this._idToGraphic.delete(e),t):null}update(e,t){this.onUpdate(e,t)}get size(){return this._idToGraphic.size}}let f=class extends(o(i(r))){constructor(){super(...arguments),this._updateInfo={websocket:0,client:0},this.graphics=new h}initialize(){this.addResolvingPromise(this.layer.when((()=>this._startup())))}destroy(){this.clear()}clear(){this._updateIntervalId&&(clearInterval(this._updateIntervalId),this._updateIntervalId=0),this.connection&&(this.connection.destroy(),this.connection=null),this.store&&(this.store.destroy(),this.store=null),this.graphics.clear(),this.handles.removeAll()}get updating(){return!this.connection||\"connected\"===this.connection.connectionStatus}_startup(){const{parsedUrl:e,spatialReference:t,definitionExpression:r,geometryDefinition:o,objectIdField:s,timeInfo:i,purgeOptions:a,maxReconnectionAttempts:n,maxReconnectionInterval:h,updateInterval:l}=this.layer,m=d.toJSON(this.layer.geometryType),f=t,g=this.layerView.view.spatialReference,_={geometry:o,where:r};this.clear(),this._set(\"connection\",p(e,f,g,m,_,n,h)),this._outSpatialReference=g.toJSON(),this.store=new y(this._onUpdate.bind(this)),this.featuresManager=new c(this.store,s,i.toJSON(),a),this.handles.add([this.connection.on(\"feature\",(e=>this._onFeature(e))),this.layer.watch(\"definitionExpression\",(()=>this._startup())),this.layer.watch(\"geometryDefinition\",(()=>this._startup())),this.layer.watch(\"purgeOptions\",(()=>this._startup()))]);let I=performance.now();this._updateIntervalId=setInterval((()=>{const e=performance.now(),t=e-I;if(t>u){I=e;const r=Math.round(this._updateInfo.client/(t/1e3)),o=Math.round(this._updateInfo.websocket/(t/1e3));this._updateInfo.client=0,this._updateInfo.websocket=0,this.layerView.emit(\"update-rate\",{client:r,websocket:o})}this.featuresManager.checkForUpdates()}),l)}_onFeature(e){this._updateInfo.websocket++,this.layerView.hasEventListener(\"data-received\")&&this.layerView.emit(\"data-received\",{attributes:e.attributes,centroid:e.centroid,geometry:e.geometry});try{s(e.geometry)&&!e.geometry.spatialReference&&(e.geometry.spatialReference=this._outSpatialReference);const t=m.fromJSON(e);t.sourceLayer=t.layer=this.layer,this.featuresManager.add(t)}catch{}}_onUpdate(e,t){s(t)&&this.graphics.removeMany(t),s(e)&&(this._updateInfo.client+=e.length,this.graphics.addMany(e))}};e([a()],f.prototype,\"connection\",void 0),e([a()],f.prototype,\"layer\",void 0),e([a()],f.prototype,\"layerView\",void 0),e([a({readOnly:!0})],f.prototype,\"updating\",null),f=e([n(\"esri.layers.graphics.controllers.StreamController\")],f);const g=f;export{g as default};\n","/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.22/esri/copyright.txt for details.\n*/\nimport{_ as r}from\"../../chunks/tslib.es6.js\";import{property as o}from\"../../core/accessorSupport/decorators/property.js\";import\"../../core/arrayUtils.js\";import\"../../core/has.js\";import\"../../core/accessorSupport/ensureType.js\";import{subclass as t}from\"../../core/accessorSupport/decorators/subclass.js\";import e from\"../../layers/support/FeatureFilter.js\";const s=s=>{let c=class extends s{constructor(...r){super(...r),this.connectionError=null,this.connectionStatus=\"disconnected\",this.filter=null}};return r([o({readOnly:!0})],c.prototype,\"connectionError\",void 0),r([o({aliasOf:\"controller.connection.connectionStatus\",readOnly:!0})],c.prototype,\"connectionStatus\",void 0),r([o({type:e})],c.prototype,\"filter\",void 0),c=r([t(\"esri.layers.mixins.StreamLayerView\")],c),c};export{s as StreamLayerView,s as default};\n","/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.22/esri/copyright.txt for details.\n*/\nimport{_ as r}from\"../../../chunks/tslib.es6.js\";import e from\"../../../core/Error.js\";import{property as o}from\"../../../core/accessorSupport/decorators/property.js\";import\"../../../core/arrayUtils.js\";import\"../../../core/has.js\";import\"../../../core/accessorSupport/ensureType.js\";import{subclass as t}from\"../../../core/accessorSupport/decorators/subclass.js\";import s from\"../../../layers/graphics/controllers/StreamController.js\";import i from\"../../../rest/support/Query.js\";import{FeatureLikeLayerView3D as a}from\"./FeatureLikeLayerView3D.js\";import{LayerView3D as n}from\"./LayerView3D.js\";import p from\"../../layers/LayerView.js\";import{StreamLayerView as l}from\"../../layers/StreamLayerView.js\";let c=class extends(l(a(n(p)))){constructor(){super(...arguments),this.type=\"stream-3d\",this.updatePolicy=0,this.hasZ=!0,this.hasM=!1}get connectionError(){const r=this.get(\"controller.connection.errorString\");if(r)return new e(\"stream-controller\",r)}createQuery(){return new i({outFields:[\"*\"],returnGeometry:!0,outSpatialReference:this.view.spatialReference})}queryLatestObservations(r,e){return this.queryEngine.executeQueryForLatestObservations(this._ensureQuery(r),null==e?void 0:e.signal)}createController(){return new s({layer:this.layer,layerView:this})}beforeSetController(){}};r([o({readOnly:!0})],c.prototype,\"updatePolicy\",void 0),r([o({readOnly:!0})],c.prototype,\"connectionError\",null),r([o()],c.prototype,\"controller\",void 0),r([o({readOnly:!0})],c.prototype,\"hasZ\",void 0),r([o({readOnly:!0})],c.prototype,\"hasM\",void 0),c=r([t(\"esri.views.3d.layers.StreamLayerView3D\")],c);const y=c;export{y as default};\n"],"sourceRoot":""}