(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-7e3033f8"],{"563d":function(e,t,r){"use strict";r.d(t,"a",(function(){return C}));var s=r("a4ee"),i=(r("e06a"),r("2eab")),o=r("ce50"),n=r("e92d"),a=r("b2b2"),c=r("f4cc"),d=r("e041"),u=(r("cea0"),r("b50f"),r("c120"),r("2dd4"),r("d386")),h=r("59b2"),l=r("b0f5"),b=r("ce6d"),f=r("9096");let p=class extends(b["a"].EventedMixin(f["a"])){onFeature(e){this.emit("feature",e)}};p=Object(s["a"])([Object(u["a"])("esri.layers.graphics.sources.connections.StreamConnection")],p);const _=p,y=n["a"].getLogger("esri.layers.graphics.sources.connections.WebSocketConnection");var g;!function(e){e[e.CONNECTING=0]="CONNECTING",e[e.OPEN=1]="OPEN",e[e.CLOSING=2]="CLOSING",e[e.CLOSED=3]="CLOSED"}(g||(g={}));let O=class extends _{constructor(e){super(),this.errorString=null;const{geometryType:t,spatialReference:r,sourceSpatialReference:s}=e;this._config=e,this._featureZScaler=Object(l["a"])(t,s,r),this._open()}async _open(){await this._tryCreateWebSocket(),this.destroyed||await this._handshake()}destroy(){Object(a["l"])(this._websocket)&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null}get connectionStatus(){if(Object(a["k"])(this._websocket))return"disconnected";switch(this._websocket.readyState){case g.CONNECTING:case g.OPEN:return"connected";case g.CLOSING:case g.CLOSED:return"disconnected"}}async _tryCreateWebSocket(e=this._config.source.path,t=1e3,r=0){try{if(this.destroyed)return;const t=Object(d["e"])(e,this._config.customParameters);this._websocket=await this._createWebSocket(t),this.notifyChange("connectionStatus")}catch(s){const i=t/1e3;return this._config.maxReconnectionAttempts&&r>=this._config.maxReconnectionAttempts?(y.error(new o["a"]("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),void this.destroy()):(y.error(new o["a"]("websocket-connection",`Failed to connect. Attempting to reconnect in ${i}s`,s)),await Object(c["a"])(t),this._tryCreateWebSocket(e,Math.min(1.5*t,1e3*this._config.maxReconnectionInterval),r+1))}}_createWebSocket(e){return new Promise((t,r)=>{const s=new WebSocket(e);s.onopen=()=>{if(s.onopen=null,this.destroyed)return s.onclose=null,void s.close();s.onclose=e=>this._onClose(e),s.onerror=e=>this._onError(e),s.onmessage=e=>this._onMessage(e),t(s)},s.onclose=e=>{s.onopen=s.onclose=null,r(e)}})}async _handshake(e=1e4){const t=this._websocket;if(Object(a["k"])(t))return;const r=Object(c["g"])(),s=t.onmessage,{filter:i,outFields:n,spatialReference:d}=this._config;return r.timeout(e),t.onmessage=e=>{var a;let c=null;try{c=JSON.parse(e.data)}catch(u){}c&&"object"==typeof c||(y.error(new o["a"]("websocket-connection","Protocol violation. Handshake failed - malformed message",e.data)),r.reject(),this.destroy()),(null==(a=c.spatialReference)?void 0:a.wkid)!==(null==d?void 0:d.wkid)&&(y.error(new o["a"]("websocket-connection","Protocol violation. Handshake failed - expected wkid of "+d.wkid,e.data)),r.reject(),this.destroy()),"json"!==c.format&&(y.error(new o["a"]("websocket-connection","Protocol violation. Handshake failed - format is not set",e.data)),r.reject(),this.destroy()),i&&c.filter!==i&&y.error(new o["a"]("websocket-connection","Tried to set filter, but server doesn't support it")),n&&c.outFields!==n&&y.error(new o["a"]("websocket-connection","Tried to set outFields, but server doesn't support it")),t.onmessage=s,r.resolve()},t.send(JSON.stringify({filter:i,outFields:n,format:"json",spatialReference:{wkid:d.wkid}})),r.promise}_onMessage(e){try{const t=JSON.parse(e.data);if("featureResult"!==t.type)throw new o["a"]("websocket-connection","Protocol violation - Expected to find message of type 'featureResult'",t);for(const e of t.features)Object(a["l"])(this._featureZScaler)&&this._featureZScaler(e.geometry),this.onFeature(e)}catch(t){return y.error(new o["a"]("websocket-connection","Failed to parse message",t)),void this.destroy()}}_onError(e){const t="Encountered an error over WebSocket connection";this._set("errorString",t),y.error("websocket-connection",t)}_onClose(e){this._websocket=null,this.notifyChange("connectionStatus"),1e3!==e.code&&y.error("websocket-connection","WebSocket closed unexpectedly with error code "+e.code),this.destroyed||this._open()}};Object(s["a"])([Object(h["b"])()],O.prototype,"connectionStatus",null),Object(s["a"])([Object(h["b"])()],O.prototype,"errorString",void 0),O=Object(s["a"])([Object(u["a"])("esri.layers.graphics.sources.connections.WebSocketConnection")],O);var m=r("e9fc"),w=r("69dd"),v=r("a9ab"),j=r("5996");const k=n["a"].getLogger("esri.layers.graphics.sources.connections.GeoEventConnection"),S=1e4,I={maxQueryDepth:5,maxRecordCountFactor:3};let F=class extends O{constructor(e){super({...I,...e})}async _open(){const e=await this._fetchServiceDefinition(this._config.source);e.timeInfo.trackIdField||k.warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect.");const t=this._fetchWebSocketUrl(e.streamUrls,this._config.spatialReference);this._buddyServicesQuery||(this._buddyServicesQuery=this._queryBuddyServices()),await this._buddyServicesQuery,await this._tryCreateWebSocket(t);const{filter:r,outFields:s}=this._config;this.destroyed||this._setFilter(r,s)}_onMessage(e){let t;try{t=this._enrich(JSON.parse(e.data)),Object(a["l"])(this._featureZScaler)&&this._featureZScaler(t.geometry)}catch(r){return void k.error(new o["a"]("geoevent-connection","Failed to parse message",r))}this.onFeature(t)}async _fetchServiceDefinition(e){const t={f:"json",...this._config.customParameters},r=Object(i["default"])(e.path,{query:t,responseType:"json"}),s=(await r).data;return this._serviceDefinition=s,s}_fetchWebSocketUrl(e,t){const r=e[0],{urls:s,token:i}=r,o=this._inferWebSocketBaseUrl(s);return Object(d["e"])(o+"/subscribe",{outSR:""+t.wkid,token:i})}_inferWebSocketBaseUrl(e){if(1===e.length)return e[0];for(const t of e)if(-1!==t.indexOf("wss"))return t;return k.error(new o["a"]("geoevent-connection","Unable to infer WebSocket url",e)),null}async _setFilter(e,t){const r=this._websocket;if(Object(a["k"])(r)||Object(a["k"])(e)&&Object(a["k"])(t))return;const s=JSON.stringify({filter:this._serializeFilter(e,t)});let i=!1;const n=Object(c["g"])(),d=()=>{i||(this.destroyed||this._websocket!==r||k.error(new o["a"]("geoevent-connection","Server timed out when setting filter")),n.reject())},u=e=>{const t=JSON.parse(e.data);t.filter&&(t.error&&(k.error(new o["a"]("geoevent-connection","Failed to set service filter",t.error)),this._set("errorString","Could not set service filter - "+t.error),n.reject(t.error)),r.onmessage=this._onMessage.bind(this),i=!0,n.resolve())};return r.onmessage=u,r.send(s),setTimeout(d,S),n.promise}_serializeFilter(e,t){const r={};if(Object(a["k"])(e)&&Object(a["k"])(t))return r;if(Object(a["l"])(e)&&e.geometry)try{const t=Object(v["a"])(e.geometry);if("extent"!==t.type)throw new o["a"]("Expected extent but found type "+t.type);r.geometry=JSON.stringify(t.shiftCentralMeridian())}catch(s){k.error(new o["a"]("geoevent-connection","Encountered an error when setting connection geometryDefinition",s))}return Object(a["l"])(e)&&e.where&&"1 = 1"!==e.where&&(r.where=e.where),Object(a["l"])(t)&&(r.outFields=t.join(",")),r}_enrich(e){if(!this._relatedFeatures)return e;const t=this._serviceDefinition.relatedFeatures.joinField,r=e.attributes[t];if(!this._relatedFeatures.has(r))return k.warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",e),e;const{attributes:s,geometry:i}=this._relatedFeatures.get(r);for(const o in s)e.attributes[o]=s[o];return i&&(e.geometry=i),e.geometry||e.centroid||k.error(new o["a"]("geoevent-connection","Found malformed feature - no geometry found",e)),e}async _queryBuddyServices(){try{const{relatedFeatures:e,keepLatestArchive:t}=this._serviceDefinition,r=this._queryRelatedFeatures(e),s=this._queryArchive(t);await r;const i=await s;if(!i)return;for(const o of i.features)this.onFeature(this._enrich(o))}catch(e){k.error(new o["a"]("geoevent-connection","Encountered an error when querying buddy services",{error:e}))}}async _queryRelatedFeatures(e){if(!e)return;const t=await this._queryBuddy(e.featuresUrl);this._addRelatedFeatures(t)}async _queryArchive(e){if(e)return this._queryBuddy(e.featuresUrl)}async _queryBuddy(e){const t=new((await Promise.resolve().then(r.bind(null,"5bd5"))).default)({url:e}),{capabilities:s}=await t.load(),i=s.query.supportsMaxRecordCountFactor,o=s.query.supportsPagination,n=s.query.supportsCentroid,c=this._config.maxRecordCountFactor,d=t.capabilities.query.maxRecordCount,u=i?d*c:d,h=new w["a"];if(h.outFields=Object(a["v"])(this._config.outFields,["*"]),h.where=Object(a["v"])(Object(a["j"])(this._config.filter,"where"),"1=1"),h.returnGeometry=!0,h.returnExceededLimitFeatures=!0,h.outSpatialReference=j["a"].fromJSON(this._config.spatialReference),n&&(h.returnCentroid=!0),i&&(h.maxRecordCountFactor=c),o)return h.num=u,t.destroy(),this._queryPages(e,h);const l=await Object(m["executeQuery"])(e,h,this._config.sourceSpatialReference);return t.destroy(),l.data}async _queryPages(e,t,r=[],s=0){t.start=Object(a["l"])(t.num)?s*t.num:null;const{data:i}=await Object(m["executeQuery"])(e,t,this._config.sourceSpatialReference);return i.exceededTransferLimit&&s<this._config.maxQueryDepth?(i.features.forEach(e=>r.push(e)),this._queryPages(e,t,r,s+1)):(r.forEach(e=>i.features.push(e)),i)}_addRelatedFeatures(e){const t=new Map,r=e.features,s=this._serviceDefinition.relatedFeatures.joinField;for(const i of r){const e=i.attributes[s];t.set(e,i)}this._relatedFeatures=t}};F=Object(s["a"])([Object(u["a"])("esri.layers.graphics.sources.connections.GeoEventConnection")],F);const x=F;function C(e,t,r,s,i,o,n,a){const c=0===e.path.indexOf("wss://")||0===e.path.indexOf("ws://"),d={source:e,sourceSpatialReference:t,spatialReference:r,geometryType:s,filter:i,maxReconnectionAttempts:o,maxReconnectionInterval:n,customParameters:a};return c?new O(d):new x(d)}},"7ab1":function(e,t,r){"use strict";r.d(t,"a",(function(){return d}));var s=r("971e"),i=r("38a4"),o=r("b2b2");const n="__esri_stream_id__",a="__esri_timestamp__",c=1e3;class d{constructor(e,t,r,s,i=128){this._trackIdToObservations=new Map,this._idCounter=0,this._lastPurge=performance.now(),this._addOrUpdated=new Map,this._removed=[],this._maxAge=0,this._timeInfo=r,this._purgeOptions=s,this.store=e,this.objectIdField=t,this.purgeInterval=i,this._useGeneratedIds=this.objectIdField===n}add(e){if(this._useGeneratedIds){const t=this._nextId();e.attributes[this.objectIdField]=t,e.objectId=t}else e.objectId=e.attributes[this.objectIdField];if(this._addOrUpdated.set(e.objectId,e),this._maxAge=Math.max(this._maxAge,e.attributes[this._timeInfo.startTimeField]),!this._timeInfo.trackIdField)return Object(o["k"])(this._trackIdLessObservations)&&(this._trackIdLessObservations=new s["a"](1e5)),void this._trackIdLessObservations.enqueue(e.objectId);const t=e.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(t)){const e=Object(o["l"])(this._purgeOptions)&&null!=this._purgeOptions.maxObservations?this._purgeOptions.maxObservations:c,r=Object(i["f"])(e,0,c);this._trackIdToObservations.set(t,new s["a"](r))}const r=this._trackIdToObservations.get(t).enqueue(e.objectId);Object(o["l"])(r)&&(this._addOrUpdated.has(r)?this._addOrUpdated.delete(r):this._removed.push(r))}checkForUpdates(){const e=this._getToAdd(),t=this._getToRemove(),r=performance.now();r-this._lastPurge>=this.purgeInterval&&(this._purge(r),this._lastPurge=r);const s=[];if(Object(o["l"])(t))for(const i of t){const e=this.store.removeById(i);Object(o["l"])(e)&&s.push(e)}if(Object(o["l"])(e))for(const i of e)i.attributes[a]=r,this.store.add(i);(e||s)&&this.store.update(e,s)}_getToAdd(){if(!this._addOrUpdated.size)return null;const e=new Array(this._addOrUpdated.size);let t=0;return this._addOrUpdated.forEach(r=>e[t++]=r),this._addOrUpdated.clear(),e}_getToRemove(){const e=this._removed;return this._removed.length?(this._removed=[],e):null}_nextId(){const e=this._idCounter;return this._idCounter=(this._idCounter+1)%4294967294+1,e}_purge(e){const t=this._purgeOptions;Object(o["l"])(t)&&(this._purgeSomeByDisplayCount(t),this._purgeByAge(t),this._purgeByAgeReceived(e,t),this._purgeTracks())}_purgeSomeByDisplayCount(e){if(!e.displayCount)return;let t=this.store.size;if(t>e.displayCount){if(this._timeInfo.trackIdField)for(const r of this._trackIdToObservations.values())if(t>e.displayCount&&r.size){const e=Object(o["u"])(r.dequeue());this._removed.push(e),t--}if(Object(o["l"])(this._trackIdLessObservations)){let r=t-e.displayCount;for(;r-- >0;){const e=this._trackIdLessObservations.dequeue();Object(o["l"])(e)&&this._removed.push(e)}}}}_purgeByAge(e){var t;if(!e.age||null==(t=this._timeInfo)||!t.startTimeField)return;const r=60*e.age*1e3,s=this._maxAge-r;this.store.forEach(e=>{e.attributes[this._timeInfo.startTimeField]<s&&this._removed.push(e.objectId)})}_purgeByAgeReceived(e,t){if(!t.ageReceived)return;const r=e-60*t.ageReceived*1e3;this.store.forEach(e=>{e.attributes[a]<r&&this._removed.push(e.objectId)})}_purgeTracks(){this._trackIdToObservations.forEach((e,t)=>{0===e.size&&this._trackIdToObservations.delete(t)})}}},"971e":function(e,t,r){"use strict";r.d(t,"a",(function(){return i}));var s=r("b2b2");class i{constructor(e){this.size=0,this._start=0,this.maxSize=e,this._buffer=new Array(e)}get entries(){return this._buffer}enqueue(e){if(this.size===this.maxSize){const t=this._buffer[this._start];return this._buffer[this._start]=e,this._start=(this._start+1)%this.maxSize,t}return this._buffer[(this._start+this.size++)%this.maxSize]=e,null}dequeue(){if(0===this.size)return null;const e=this._buffer[this._start];return this._buffer[this._start]=null,this.size--,this._start=(this._start+1)%this.maxSize,e}peek(){return 0===this.size?null:this._buffer[this._start]}find(e){if(0===this.size)return null;for(const t of this._buffer)if(Object(s["l"])(t)&&e(t))return t;return null}clear(e){let t=this.dequeue();for(;Object(s["l"])(t);)e&&e(t),t=this.dequeue()}}},a7bf:function(e,t,r){"use strict";r.r(t),r.d(t,"default",(function(){return C}));var s,i=r("a4ee"),o=r("ce50"),n=r("59b2"),a=(r("b50f"),r("c120"),r("cea0"),r("d386")),c=(r("e06a"),r("8d60")),d=r("fc29"),u=r("9096"),h=r("b2b2"),l=r("fab3"),b=r("7ab1"),f=r("563d"),p=r("3895"),_=r("74e2");const y=2500;let g=s=class extends c["a"]{getObjectId(){return this.objectId}clone(){return new s({objectId:this.objectId,...this.cloneProperties()})}};Object(i["a"])([Object(n["b"])({type:Number,json:{read:!0}})],g.prototype,"objectId",void 0),g=s=Object(i["a"])([Object(a["a"])("esri.layers.graphics.controllers.StreamGraphic")],g);class O{constructor(e){this.onUpdate=e,this._idToGraphic=new Map}destroy(){this._idToGraphic.clear()}add(e){this._idToGraphic.set(e.objectId,e)}get(e){return this._idToGraphic.get(e)}forEach(e){this._idToGraphic.forEach(e)}removeById(e){const t=this._idToGraphic.get(e);return t?(t.sourceLayer=t.layer=null,this._idToGraphic.delete(e),t):null}update(e,t){this.onUpdate(e,t)}get size(){return this._idToGraphic.size}}let m=class extends(Object(u["b"])(Object(l["b"])(d["a"]))){constructor(){super(...arguments),this._updateInfo={websocket:0,client:0},this.graphics=new p["a"]}initialize(){this.addResolvingPromise(this.layer.when(()=>this._startup()))}destroy(){this.clear()}clear(){this._updateIntervalId&&(clearInterval(this._updateIntervalId),this._updateIntervalId=0),this.connection&&(this.connection.destroy(),this.connection=null),this.store&&(this.store.destroy(),this.store=null),this.graphics.clear(),this.handles.removeAll()}get updating(){return!this.connection||"connected"===this.connection.connectionStatus}_startup(){const{parsedUrl:e,spatialReference:t,definitionExpression:r,geometryDefinition:s,objectIdField:i,timeInfo:o,purgeOptions:n,maxReconnectionAttempts:a,maxReconnectionInterval:c,updateInterval:d}=this.layer,u=_["a"].toJSON(this.layer.geometryType),h=t,l=this.layerView.view.spatialReference,p={geometry:s,where:r};this.clear(),this._set("connection",Object(f["a"])(e,h,l,u,p,a,c)),this._outSpatialReference=l.toJSON(),this.store=new O(this._onUpdate.bind(this)),this.featuresManager=new b["a"](this.store,i,o.toJSON(),n),this.handles.add([this.connection.on("feature",e=>this._onFeature(e)),this.layer.watch("definitionExpression",()=>this._startup()),this.layer.watch("geometryDefinition",()=>this._startup()),this.layer.watch("purgeOptions",()=>this._startup())]);let g=performance.now();this._updateIntervalId=setInterval(()=>{const e=performance.now(),t=e-g;if(t>y){g=e;const r=Math.round(this._updateInfo.client/(t/1e3)),s=Math.round(this._updateInfo.websocket/(t/1e3));this._updateInfo.client=0,this._updateInfo.websocket=0,this.layerView.emit("update-rate",{client:r,websocket:s})}this.featuresManager.checkForUpdates()},d)}_onFeature(e){this._updateInfo.websocket++,this.layerView.hasEventListener("data-received")&&this.layerView.emit("data-received",{attributes:e.attributes,centroid:e.centroid,geometry:e.geometry});try{Object(h["l"])(e.geometry)&&!e.geometry.spatialReference&&(e.geometry.spatialReference=this._outSpatialReference);const t=g.fromJSON(e);t.sourceLayer=t.layer=this.layer,this.featuresManager.add(t)}catch{}}_onUpdate(e,t){Object(h["l"])(t)&&this.graphics.removeMany(t),Object(h["l"])(e)&&(this._updateInfo.client+=e.length,this.graphics.addMany(e))}};Object(i["a"])([Object(n["b"])()],m.prototype,"connection",void 0),Object(i["a"])([Object(n["b"])()],m.prototype,"layer",void 0),Object(i["a"])([Object(n["b"])()],m.prototype,"layerView",void 0),Object(i["a"])([Object(n["b"])({readOnly:!0})],m.prototype,"updating",null),m=Object(i["a"])([Object(a["a"])("esri.layers.graphics.controllers.StreamController")],m);const w=m;var v=r("69dd"),j=r("2ab4"),k=r("66af"),S=r("365a"),I=r("96d4");const F=e=>{let t=class extends e{constructor(...e){super(...e),this.connectionError=null,this.connectionStatus="disconnected",this.filter=null}};return Object(i["a"])([Object(n["b"])({readOnly:!0})],t.prototype,"connectionError",void 0),Object(i["a"])([Object(n["b"])({aliasOf:"controller.connection.connectionStatus",readOnly:!0})],t.prototype,"connectionStatus",void 0),Object(i["a"])([Object(n["b"])({type:I["a"]})],t.prototype,"filter",void 0),t=Object(i["a"])([Object(a["a"])("esri.layers.mixins.StreamLayerView")],t),t};let x=class extends(F(Object(j["a"])(Object(k["a"])(S["a"])))){constructor(){super(...arguments),this.type="stream-3d",this.updatePolicy=0,this.hasZ=!0,this.hasM=!1}get connectionError(){const e=this.get("controller.connection.errorString");if(e)return new o["a"]("stream-controller",e)}createQuery(){return new v["a"]({outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference})}queryLatestObservations(e,t){return this.queryEngine.executeQueryForLatestObservations(this._ensureQuery(e),null==t?void 0:t.signal)}createController(){return new w({layer:this.layer,layerView:this})}beforeSetController(){}};Object(i["a"])([Object(n["b"])({readOnly:!0})],x.prototype,"updatePolicy",void 0),Object(i["a"])([Object(n["b"])({readOnly:!0})],x.prototype,"connectionError",null),Object(i["a"])([Object(n["b"])()],x.prototype,"controller",void 0),Object(i["a"])([Object(n["b"])({readOnly:!0})],x.prototype,"hasZ",void 0),Object(i["a"])([Object(n["b"])({readOnly:!0})],x.prototype,"hasM",void 0),x=Object(i["a"])([Object(a["a"])("esri.views.3d.layers.StreamLayerView3D")],x);const C=x}}]);
//# sourceMappingURL=chunk-7e3033f8.960db08d.js.map